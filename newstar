#! /usr/bin/env python

'''
OpenStack Nova shell, taking an excuse to make usability improvements
'''

import os, sys
from os.path import expanduser
from subprocess import Popen, PIPE, call
import time
import cmd, readline
import shlex
from argparse import ArgumentParser
import getpass
import threading, Queue
import yaml

# TODO Show all VMs and filter by status
# TODO Multithread listing

DIR = '~/.newstar'
CERT = '/path/to/certificate.pem'

def showworker(vms, inqueue, outqueue, credentials):
    '''
    VM info querying thread worker
    '''

    while True:
        server = inqueue.get()

        try:
            service, url, tenant = vms[server]

            null = open(os.devnull, 'w')
            # Would receive a KeyboardInterrupt too but that's fine
            proc = Popen(['nova', '--os-cacert', CERT, '--os-username',
                          credentials['username'], '--os-password',
                          credentials['password'], '--os-auth-url', url,
                          '--os-tenant-name', tenant, 'show', server],
                          stdout=PIPE, stderr=null)
            output = proc.stdout.read()
            null.close()
            if output: # Make sure not empty if KeyboardInterrupted
                outqueue.put((service, tenant, output))
        except KeyError:
            outqueue.put("Couldn't find %s" % server)
        inqueue.task_done()

def printworker(outqueue):
    '''
    VM info printing thread worker
    '''

    while True:
        info = outqueue.get()
        try:
            service, tenant, output = info
            print "In %s, %s:" % (tenant, service.capitalize())
            print output
        except ValueError:
            print info
        outqueue.task_done()

class Cli(cmd.Cmd):
    '''
    CLI
    '''

    def __init__(self, args):
        '''
        Init CLI
        '''

        cmd.Cmd.__init__(self)

        self.time = args.time

        # Set prompt and window title
        self.prompt = 'nova% '
        print '\033]0;nova\007\r', # pylint: disable=W1401

        # Read history
        histfile = expanduser(DIR + '/histfile')
        if os.path.exists(histfile):
            readline.read_history_file(histfile)

        # Argument parsers
        self.listparser = ArgumentParser(prog='list', description="List VMs.")
        self.listparser.add_argument('-v', '--verbose', action='store_true',
                                     help="display VM details" )
        self.listparser.add_argument('-e', '--error', action='store_true',
                                      help="only display VMs in ERROR state")

        self.showparser = ArgumentParser(prog='show',
                                         description="Show VM details.")
        self.showparser.add_argument('-a', '--all', dest="allvms",
                                     action='store_true')
        self.showparser.add_argument('-c', '--cached', action='store_true',
                                     help="Use cached VM-tenant mapping")
        self.showparser.add_argument('server', nargs='*')

        self.rebootparser = ArgumentParser(prog='reboot',
                                           description="Reboot VMs.")
        self.rebootparser.add_argument('--hard', action='store_true',
                                       help="reboot hard")
        self.rebootparser.add_argument('server', nargs='+')

        # Initialise VM-tenant mapping
        self.vms = {}

        # Credentials
        self.credentials = {}

        # Tenant files
        directory = expanduser(DIR)
        if not os.path.isdir(directory):
            os.mkdir(directory)
        yamlfile = directory + '/newstar.yaml'
        if os.path.exists(yamlfile):
            self.services = yaml.load(open(yamlfile))
        else:
            print >> sys.stderr, "Couldn't find %s" % yamlfile
            sys.exit(1)

        # Start threads to permanently pull VMs to show the info of
        self.inqueue = Queue.Queue()
        self.outqueue = Queue.Queue()
        for _ in range(16): # 16 seems to be the optimal balance
            thread = threading.Thread(target=showworker,
                                      args=(self.vms,
                                            self.inqueue, self.outqueue,
                                            self.credentials))
            thread.daemon = True # Stop thread when parent process ends
            thread.start()

        # Printer thread
        thread = threading.Thread(target=printworker, args=(self.outqueue,))
        thread.daemon = True
        thread.start()

    def authck(self):
        '''
        Check if user has authenticated
        '''

        # Check authentication
        if not self.credentials:
            print >> sys.stderr, "You need to authenticate first"
            return False
        else:
            return True

    def _list(self, credentials, doprint, dolserror=False, verbose=False):
        '''
        List VMs
        '''

        for service in self.services:
            url = self.services[service]['url']
            tenants = self.services[service]['tenants']
            for tenant in tenants:
                if verbose:
                    print "%s, %s:" % (tenant['name'], service.capitalize())

                # Set tenant
                tenant = tenant['name']

                # Run nova
                proc = Popen(['nova', '--os-cacert', CERT, '--os-username',
                              self.credentials['username'], '--os-password',
                              self.credentials['password'], '--os-auth-url',
                              url, '--os-tenant-name', tenant, 'list'],
                             stdout=PIPE)

                # Handle header
                for line, _ in zip(proc.stdout, range(3)):
                    if verbose:
                        print line,

                # Print VMs
                for line in proc.stdout:
                    try:
                        server = line.split('|')[2].strip()
                        status = line.split('|')[3].strip()
                        self.vms[server] = service, url, tenant
                        if doprint:
                            if dolserror:
                                if status == 'ERROR':
                                    if verbose:
                                        print line,
                                    else:
                                        print server
                            else:
                                if verbose:
                                    print line,
                                else:
                                    print server
                    except IndexError:
                        if verbose:
                            print line,

                if verbose:
                    print

    def precmd(self, line):
        readline.write_history_file(expanduser(DIR + '/histfile'))
        return line

    def emptyline(self):
        '''
        Handle empty lines
        '''

        pass

    def do_show(self, line):
        '''
        Show VMs info
        '''

        # Parse arguments
        try:
            args = self.showparser.parse_args(shlex.split(line))
        except SystemExit:
            return

        if not args.server and not args.allvms:
            self.showparser.print_help()
            return

        if not self.authck():
            return

        # Update VM-tenant mapping
        time0 = time.time()
        if not args.cached:
            self._list(self.credentials, doprint=False)

        # Collect requested servers into queue
        if args.allvms:
            for server in self.vms:
                self.inqueue.put(server)
        else:
            for server in args.server:
                self.inqueue.put(server)

        # Wait until queue is drained
        try:
            while not self.inqueue.empty():
                time.sleep(1) # Interruptible
        except KeyboardInterrupt:
            while not self.inqueue.empty():
                self.inqueue.get()
                self.inqueue.task_done()
        self.inqueue.join()
        self.outqueue.join()
        if self.time:
            print time.time() - time0

    def help_show(self): # pylint: disable=R0201
        '''
        Help with show
        '''

        print "Show VMs info"

    def do_list(self, line):
        '''
        List VMs
        '''

        # Parse arguments
        try:
            args = self.listparser.parse_args(shlex.split(line))
        except SystemExit:
            return

        if not self.authck():
            return

        # List VMs in all tenants of all OpenStack services
        self._list(self.credentials, doprint=True, dolserror=args.error,
                   verbose=args.verbose)

    def help_list(self): # pylint: disable=R0201
        '''
        Help with list
        '''

        print "List VMs"

    def do_authenticate(self, _): # pylint: disable=R0201
        '''
        Authenticate
        '''

        self.credentials['username'] = raw_input('login: ')
        self.credentials['password'] = getpass.getpass()

        os.environ['OS_USERNAME'] = self.credentials['username']
        os.environ['OS_PASSWORD'] = self.credentials['password']

    def help_authenticate(self): # pylint: disable=R0201
        '''
        Help with authenticate
        '''

        print "Authenticate"

    def do_lstenants(self, _):
        '''
        List known tenants
        '''

        for service in self.services:
            tenants = self.services[service]['tenants']
            for tenant in tenants:
                print "'%s' in %s" % (tenant['name'], service.capitalize())

    def help_lstenants(self): # pylint: disable=R0201
        '''
        Help with lstenants
        '''

        print "List known tenants"

    def do_reboot(self, line):
        '''
        Reboot VMs
        '''

        # Parse arguments
        try:
            args = self.rebootparser.parse_args(shlex.split(line))
        except SystemExit:
            return

        if not self.authck():
            return

        # Update VM-tenant mapping
        self._list(self.credentials, doprint=False)

        for server in args.server:
            try:
                service, url, tenant = self.vms[server]

                call(['nova', '--os-cacert', CERT, '--os-username',
                      self.credentials['username'], '--os-password',
                      self.credentials['password'], '--os-auth-url', url,
                      '--os-tenant-name', tenant, 'reboot'] + \
                     (['--hard'] if args.hard else []) + [server])
            except KeyError:
                print >> sys.stderr, "Couldn't find %s" % server

    def help_reboot(self): # pylint: disable=R0201,C0103
        '''
        Help with rebooting
        '''

        self.rebootparser.print_help()

    def do_EOF(self, _): # pylint: disable=R0201,C0103
        '''
        Handle ^D
        '''

        print
        sys.exit(0)

    def help_EOF(self): # pylint: disable=R0201,C0103
        '''
        Help with EOF
        '''

        print "Exit. You could also use Ctrl-D."

    def help_help(self): # pylint: disable=R0201
        '''
        Help with help
        '''

        print "Print help"

def main():
    '''
    Main function
    '''

    parser = ArgumentParser(description="Nova shell")
    parser.add_argument('--time', action='store_true',
                        help="measure time spent in operations")
    args = parser.parse_args()
    cli = Cli(args)

    while True:
        try:
            cli.cmdloop()
        except KeyboardInterrupt:
            print

if __name__ == '__main__':
    sys.exit(main())
